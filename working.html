<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InsightFlow AI - Intelligent Data Workspace</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            900: '#0c4a6e',
                        },
                        dark: {
                            bg: '#0f1117',
                            surface: '#1e2029',
                            border: '#2f3341'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- Libraries -->
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Data Parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* Glassmorphism Utilities */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .glass-panel {
            background: rgba(30, 32, 41, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Loading Spinner */
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top: 3px solid #0ea5e9;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Typing Cursor */
        .cursor::after {
            content: 'â–‹';
            animation: blink 1s step-start infinite;
            color: #0ea5e9;
            margin-left: 2px;
        }
        @keyframes blink {
            50% { opacity: 0; }
        }

        /* Hide generic file input */
        input[type="file"] {
            display: none;
        }
        
        .active-nav {
            background: rgba(14, 165, 233, 0.15);
            color: #38bdf8;
            border-right: 3px solid #38bdf8;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-dark-bg text-gray-800 dark:text-gray-200 transition-colors duration-300 overflow-hidden h-screen flex text-sm">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-white dark:bg-dark-surface border-r border-gray-200 dark:border-dark-border flex flex-col transition-all duration-300 transform z-20 h-full">
        <div class="p-6 flex items-center gap-3 border-b border-gray-200 dark:border-dark-border">
            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-brand-500 to-indigo-600 flex items-center justify-center shadow-lg shadow-brand-500/20">
                <i data-lucide="sparkles" class="text-white w-4 h-4"></i>
            </div>
            <h1 class="font-bold text-lg tracking-tight dark:text-white">InsightFlow AI</h1>
        </div>

        <nav class="flex-1 overflow-y-auto py-4 px-3 space-y-1">
            <button onclick="app.nav('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-white/5 transition-colors active-nav">
                <i data-lucide="layout-dashboard" class="w-4 h-4"></i>
                <span>Dashboard</span>
            </button>
            <button onclick="app.nav('data')" id="nav-data" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-white/5 transition-colors">
                <i data-lucide="database" class="w-4 h-4"></i>
                <span>Data Studio</span>
            </button>
            <button onclick="app.nav('visualize')" id="nav-visualize" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-white/5 transition-colors">
                <i data-lucide="bar-chart-2" class="w-4 h-4"></i>
                <span>Visualization</span>
            </button>
            <button onclick="app.nav('insights')" id="nav-insights" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-white/5 transition-colors">
                <i data-lucide="brain-circuit" class="w-4 h-4"></i>
                <span>AI Insights</span>
            </button>
            <div class="pt-4 mt-4 border-t border-gray-200 dark:border-dark-border">
                <p class="px-3 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Workspace</p>
                <button onclick="app.toggleSettings()" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-white/5 transition-colors text-gray-500 dark:text-gray-400">
                    <i data-lucide="settings" class="w-4 h-4"></i>
                    <span>Settings</span>
                </button>
            </div>
        </nav>

        <div class="p-4 border-t border-gray-200 dark:border-dark-border">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-gradient-to-r from-pink-500 to-orange-400 flex items-center justify-center text-white font-bold text-xs">
                    JD
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium truncate dark:text-white">John Doe</p>
                    <p class="text-xs text-gray-500 truncate">Data Scientist</p>
                </div>
                <button onclick="app.toggleTheme()" class="p-2 hover:bg-gray-100 dark:hover:bg-white/10 rounded-full transition-colors">
                    <i data-lucide="moon" class="w-4 h-4 hidden dark:block"></i>
                    <i data-lucide="sun" class="w-4 h-4 block dark:hidden"></i>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative h-full overflow-hidden bg-white dark:bg-dark-bg">
        <!-- Top Bar -->
        <header class="h-16 border-b border-gray-200 dark:border-dark-border flex items-center justify-between px-6 bg-white/50 dark:bg-dark-bg/50 backdrop-blur-sm z-10">
            <div class="flex items-center gap-4">
                <button id="mobile-menu" class="md:hidden p-2 hover:bg-gray-100 dark:hover:bg-white/5 rounded-lg">
                    <i data-lucide="menu" class="w-5 h-5"></i>
                </button>
                <div class="flex items-center gap-2 text-gray-500 dark:text-gray-400 text-sm">
                    <span>Workspace</span>
                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                    <span id="breadcrumb" class="text-gray-900 dark:text-white font-medium">Dashboard</span>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="relative hidden sm:block">
                    <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="text" placeholder="Search data or ask AI..." class="bg-gray-100 dark:bg-dark-surface border-none rounded-full py-1.5 pl-9 pr-4 text-sm focus:ring-2 focus:ring-brand-500 w-64 transition-all">
                </div>
                <button class="relative p-2 hover:bg-gray-100 dark:hover:bg-white/5 rounded-full">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                    <span class="absolute top-1.5 right-1.5 w-2 h-2 bg-red-500 rounded-full border-2 border-white dark:border-dark-bg"></span>
                </button>
            </div>
        </header>

        <!-- View: Dashboard -->
        <section id="view-dashboard" class="view-section flex-1 overflow-y-auto p-6 md:p-8 animate-fade-in">
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Welcome back, John</h2>
                <p class="text-gray-500 dark:text-gray-400">Here's what's happening with your data projects today.</p>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="glass-panel p-6 rounded-xl hover:border-brand-500/50 transition-colors group">
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-2 bg-brand-500/10 rounded-lg text-brand-500">
                            <i data-lucide="hard-drive" class="w-5 h-5"></i>
                        </div>
                        <span class="text-xs font-mono text-green-400">+12%</span>
                    </div>
                    <div class="text-3xl font-bold text-gray-900 dark:text-white mb-1" id="stat-datasets">0</div>
                    <div class="text-sm text-gray-500">Active Datasets</div>
                </div>

                <div class="glass-panel p-6 rounded-xl hover:border-purple-500/50 transition-colors group">
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-2 bg-purple-500/10 rounded-lg text-purple-500">
                            <i data-lucide="activity" class="w-5 h-5"></i>
                        </div>
                        <span class="text-xs font-mono text-green-400">Good</span>
                    </div>
                    <div class="text-3xl font-bold text-gray-900 dark:text-white mb-1" id="stat-rows">0</div>
                    <div class="text-sm text-gray-500">Total Rows Processed</div>
                </div>

                <div class="glass-panel p-6 rounded-xl hover:border-orange-500/50 transition-colors group">
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-2 bg-orange-500/10 rounded-lg text-orange-500">
                            <i data-lucide="zap" class="w-5 h-5"></i>
                        </div>
                        <span class="text-xs font-mono text-gray-400">Idle</span>
                    </div>
                    <div class="text-3xl font-bold text-gray-900 dark:text-white mb-1">AI Ready</div>
                    <div class="text-sm text-gray-500">Copilot Status</div>
                </div>
            </div>

            <!-- Quick Action Area -->
            <div class="bg-gradient-to-r from-brand-900 to-indigo-900 rounded-2xl p-8 relative overflow-hidden text-white">
                <div class="relative z-10 max-w-lg">
                    <h3 class="text-xl font-bold mb-2">Start a new analysis</h3>
                    <p class="text-blue-100 mb-6">Upload a CSV, Excel, or JSON file to generate instant insights and visualizations using our local AI engine.</p>
                    <button onclick="app.nav('data')" class="bg-white text-brand-900 px-5 py-2.5 rounded-lg font-medium hover:bg-blue-50 transition-colors inline-flex items-center gap-2">
                        <i data-lucide="upload-cloud" class="w-4 h-4"></i>
                        Import Dataset
                    </button>
                </div>
                <!-- Decorative BG elements -->
                <div class="absolute right-0 top-0 w-64 h-64 bg-brand-500 rounded-full blur-3xl opacity-20 transform translate-x-1/2 -translate-y-1/2"></div>
            </div>
        </section>

        <!-- View: Data Studio -->
        <section id="view-data" class="view-section hidden flex-1 flex flex-col h-full overflow-hidden animate-fade-in">
            <!-- Toolbar -->
            <div class="h-14 border-b border-gray-200 dark:border-dark-border flex items-center justify-between px-6 bg-white dark:bg-dark-surface">
                <div class="flex items-center gap-3">
                    <button onclick="document.getElementById('file-upload').click()" class="btn-primary px-3 py-1.5 rounded-md bg-brand-600 hover:bg-brand-500 text-white text-xs font-medium flex items-center gap-2 transition-colors">
                        <i data-lucide="plus" class="w-3 h-3"></i> Upload New
                    </button>
                    <span id="current-filename" class="text-xs text-gray-500 font-mono hidden">data.csv</span>
                </div>
                <div class="flex items-center gap-2">
                    <input id="table-search" type="text" placeholder="Filter rows..." class="bg-gray-100 dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded px-2 py-1 text-xs w-48 focus:outline-none focus:border-brand-500">
                    <div class="h-4 w-[1px] bg-gray-300 dark:bg-gray-700 mx-1"></div>
                    <span id="row-count-display" class="text-xs text-gray-500">0 rows</span>
                </div>
            </div>

            <!-- Empty State / Drop Zone -->
            <div id="upload-zone" class="flex-1 flex flex-col items-center justify-center p-8 transition-all">
                <div class="border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-2xl p-12 text-center max-w-xl w-full hover:border-brand-500 hover:bg-brand-500/5 transition-all cursor-pointer group" onclick="document.getElementById('file-upload').click()">
                    <div class="w-16 h-16 bg-gray-100 dark:bg-dark-surface rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                        <i data-lucide="upload" class="w-8 h-8 text-gray-400 group-hover:text-brand-500"></i>
                    </div>
                    <h3 class="text-lg font-semibold dark:text-white mb-2">Drop your dataset here</h3>
                    <p class="text-gray-500 text-sm mb-6">Support for CSV, Excel (.xlsx), and JSON. <br> Max file size 50MB (Client-side only).</p>
                    <span class="text-xs text-brand-500 font-medium group-hover:underline">or browse files</span>
                </div>
                <input type="file" id="file-upload" accept=".csv,.json,.xlsx">
            </div>

            <!-- Table Container -->
            <div id="table-container" class="hidden flex-1 overflow-auto relative">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-50 dark:bg-dark-surface sticky top-0 z-10 shadow-sm">
                        <tr id="table-header">
                            <!-- Headers injected via JS -->
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-gray-200 dark:divide-dark-border">
                        <!-- Rows injected via JS -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div id="pagination-controls" class="hidden h-12 border-t border-gray-200 dark:border-dark-border bg-white dark:bg-dark-surface flex items-center justify-between px-6">
                <span class="text-xs text-gray-500" id="page-info">Page 1 of 1</span>
                <div class="flex gap-2">
                    <button id="prev-page" class="p-1.5 rounded hover:bg-gray-100 dark:hover:bg-white/10 disabled:opacity-50">
                        <i data-lucide="chevron-left" class="w-4 h-4"></i>
                    </button>
                    <button id="next-page" class="p-1.5 rounded hover:bg-gray-100 dark:hover:bg-white/10 disabled:opacity-50">
                        <i data-lucide="chevron-right" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- View: Visualize -->
        <section id="view-visualize" class="view-section hidden flex-1 p-6 flex flex-col h-full animate-fade-in">
            <div class="flex flex-col md:flex-row gap-6 h-full">
                <!-- Config Panel -->
                <div class="w-full md:w-64 flex-shrink-0 flex flex-col gap-4">
                    <div class="glass-panel p-4 rounded-xl">
                        <h3 class="font-semibold mb-4 text-sm uppercase tracking-wider text-gray-500">Chart Config</h3>
                        
                        <label class="block text-xs text-gray-500 mb-1">Chart Type</label>
                        <select id="chart-type" class="w-full bg-gray-100 dark:bg-dark-bg border border-gray-700 rounded px-2 py-2 text-sm mb-3">
                            <option value="bar">Bar Chart</option>
                            <option value="line">Line Chart</option>
                            <option value="pie">Pie Chart</option>
                            <option value="scatter">Scatter Plot</option>
                            <option value="doughnut">Doughnut</option>
                        </select>

                        <label class="block text-xs text-gray-500 mb-1">X Axis (Label)</label>
                        <select id="axis-x" class="w-full bg-gray-100 dark:bg-dark-bg border border-gray-700 rounded px-2 py-2 text-sm mb-3">
                            <option>Select Data First</option>
                        </select>

                        <label class="block text-xs text-gray-500 mb-1">Y Axis (Value)</label>
                        <select id="axis-y" class="w-full bg-gray-100 dark:bg-dark-bg border border-gray-700 rounded px-2 py-2 text-sm mb-4">
                            <option>Select Data First</option>
                        </select>

                        <button onclick="app.renderChart()" class="w-full py-2 bg-brand-600 hover:bg-brand-500 text-white rounded-lg text-sm font-medium transition-colors">Update Chart</button>
                    </div>

                    <div class="glass-panel p-4 rounded-xl flex-1">
                        <h3 class="font-semibold mb-2 text-sm">Export</h3>
                        <button onclick="app.downloadChart()" class="w-full py-2 border border-gray-600 hover:bg-gray-700 rounded-lg text-sm transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="download" class="w-4 h-4"></i> Download PNG
                        </button>
                    </div>
                </div>

                <!-- Canvas Area -->
                <div class="flex-1 glass-panel rounded-xl p-4 relative flex items-center justify-center bg-white dark:bg-dark-surface">
                    <div id="chart-placeholder" class="text-center text-gray-500">
                        <i data-lucide="bar-chart" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                        <p>Load data and configure axes to view chart</p>
                    </div>
                    <canvas id="mainChart" class="max-h-full max-w-full hidden"></canvas>
                </div>
            </div>
        </section>

        <!-- View: AI Insights -->
        <section id="view-insights" class="view-section hidden flex-1 p-6 flex flex-col animate-fade-in relative">
            <div id="ai-report-container" class="flex-1 overflow-y-auto pr-2 pb-20">
                <!-- Chat Stream -->
                <div class="space-y-6 max-w-3xl mx-auto">
                    <!-- Intro Message -->
                    <div class="flex gap-4 animate-slide-up">
                        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-brand-500 to-indigo-600 flex-shrink-0 flex items-center justify-center">
                            <i data-lucide="sparkles" class="text-white w-4 h-4"></i>
                        </div>
                        <div class="flex-1">
                            <div class="glass-panel p-4 rounded-2xl rounded-tl-none inline-block">
                                <p class="text-sm leading-relaxed">
                                    Hello! I'm your InsightFlow Copilot. <br>
                                    Once you upload a dataset, I can:
                                    <ul class="list-disc list-inside mt-2 text-gray-400 pl-2">
                                        <li>Generate summary statistics</li>
                                        <li>Identify correlations and outliers</li>
                                        <li>Suggest visualizations</li>
                                        <li>Draft a business report</li>
                                    </ul>
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Dynamic Chat Area -->
                    <div id="chat-history" class="space-y-6"></div>
                    
                    <!-- Loading Indicator -->
                    <div id="ai-loading" class="hidden gap-4">
                        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-brand-500 to-indigo-600 flex-shrink-0 flex items-center justify-center">
                            <i data-lucide="sparkles" class="text-white w-4 h-4"></i>
                        </div>
                        <div class="flex items-center gap-2 pt-2">
                            <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="absolute bottom-6 left-1/2 -translate-x-1/2 w-full max-w-2xl px-6">
                <div class="glass-panel p-2 rounded-2xl flex items-center gap-2 shadow-2xl shadow-brand-900/20">
                    <button class="p-2 hover:bg-white/10 rounded-xl text-gray-400 transition-colors" title="Attach Context">
                        <i data-lucide="paperclip" class="w-5 h-5"></i>
                    </button>
                    <input id="chat-input" type="text" placeholder="Ask AI to analyze your data..." class="flex-1 bg-transparent border-none focus:ring-0 text-sm px-2 text-white placeholder-gray-500" onkeydown="if(event.key === 'Enter') app.handleChat()">
                    <button onclick="app.handleChat()" class="p-2 bg-brand-600 hover:bg-brand-500 text-white rounded-xl transition-colors">
                        <i data-lucide="send" class="w-4 h-4"></i>
                    </button>
                </div>
                <div class="text-center mt-2">
                    <p class="text-[10px] text-gray-500">AI can make mistakes. Review generated insights.</p>
                </div>
            </div>
        </section>

        <!-- Toast Notification -->
        <div id="toast" class="fixed bottom-6 right-6 transform translate-y-20 opacity-0 transition-all duration-300 z-50">
            <div class="bg-gray-900 text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 border border-gray-700">
                <i data-lucide="check-circle" class="text-green-400 w-5 h-5"></i>
                <span id="toast-msg" class="text-sm font-medium">Operation successful</span>
            </div>
        </div>

    </main>

    <script>
        // --- Core Application Logic ---
        
        const app = {
            state: {
                currentView: 'dashboard',
                data: [], // Full dataset
                headers: [],
                meta: {},
                currentPage: 1,
                rowsPerPage: 50,
                theme: localStorage.getItem('theme') || 'dark',
                chartInstance: null
            },

            init() {
                // Initialize Icons
                lucide.createIcons();
                
                // Theme Setup
                if (this.state.theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }

                // Event Listeners
                this.setupFileUpload();
                this.setupNavigation();
                
                // Setup Mobile Menu
                document.getElementById('mobile-menu').addEventListener('click', () => {
                    document.getElementById('sidebar').classList.toggle('-translate-x-full');
                });
            },

            // --- Navigation & UI ---

            nav(viewId) {
                // Update State
                this.state.currentView = viewId;
                
                // Update Sidebar UI
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active-nav'));
                document.getElementById(`nav-${viewId}`).classList.add('active-nav');

                // Update Breadcrumb
                const titles = { dashboard: 'Dashboard', data: 'Data Studio', visualize: 'Visualization', insights: 'AI Insights' };
                document.getElementById('breadcrumb').textContent = titles[viewId];

                // Toggle Sections
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                const target = document.getElementById(`view-${viewId}`);
                target.classList.remove('hidden');
                
                // Trigger re-animations
                target.classList.remove('animate-fade-in');
                void target.offsetWidth; // trigger reflow
                target.classList.add('animate-fade-in');
            },

            toggleTheme() {
                this.state.theme = this.state.theme === 'dark' ? 'light' : 'dark';
                localStorage.setItem('theme', this.state.theme);
                if (this.state.theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            },

            showToast(msg) {
                const toast = document.getElementById('toast');
                document.getElementById('toast-msg').textContent = msg;
                toast.classList.remove('translate-y-20', 'opacity-0');
                setTimeout(() => {
                    toast.classList.add('translate-y-20', 'opacity-0');
                }, 3000);
            },

            // --- Data Handling ---

            setupFileUpload() {
                const fileInput = document.getElementById('file-upload');
                fileInput.addEventListener('change', (e) => this.handleFile(e.target.files[0]));
                
                // Drag & Drop
                const zone = document.getElementById('upload-zone');
                zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('border-brand-500'); });
                zone.addEventListener('dragleave', (e) => { e.preventDefault(); zone.classList.remove('border-brand-500'); });
                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    zone.classList.remove('border-brand-500');
                    if(e.dataTransfer.files.length) this.handleFile(e.dataTransfer.files[0]);
                });
            },

            handleFile(file) {
                if(!file) return;

                // Show basic loading
                this.showToast("Processing file...");
                
                const reader = new FileReader();
                const name = file.name;
                const extension = name.split('.').pop().toLowerCase();

                document.getElementById('current-filename').textContent = name;
                document.getElementById('current-filename').classList.remove('hidden');

                if (extension === 'csv') {
                    Papa.parse(file, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            this.loadData(results.data, results.meta.fields);
                        }
                    });
                } else if (extension === 'json') {
                    reader.onload = (e) => {
                        try {
                            const json = JSON.parse(e.target.result);
                            const data = Array.isArray(json) ? json : [json];
                            const headers = Object.keys(data[0] || {});
                            this.loadData(data, headers);
                        } catch(err) { alert('Invalid JSON'); }
                    };
                    reader.readAsText(file);
                } else if (extension === 'xlsx' || extension === 'xls') {
                    reader.onload = (e) => {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                        
                        // Convert Array of Arrays to Array of Objects
                        const headers = jsonData[0];
                        const rows = jsonData.slice(1).map(row => {
                            let obj = {};
                            headers.forEach((h, i) => obj[h] = row[i]);
                            return obj;
                        });
                        this.loadData(rows, headers);
                    };
                    reader.readAsArrayBuffer(file);
                }
            },

            loadData(data, headers) {
                this.state.data = data;
                this.state.headers = headers;
                
                // Reset View
                document.getElementById('upload-zone').classList.add('hidden');
                document.getElementById('table-container').classList.remove('hidden');
                document.getElementById('pagination-controls').classList.remove('hidden');

                // Update Dashboard Stats
                document.getElementById('stat-datasets').textContent = "1";
                document.getElementById('stat-rows').textContent = data.length.toLocaleString();

                // Populate Dropdowns
                this.populateDropdowns(headers);

                // Render Table
                this.renderTable();
                this.showToast("Dataset loaded successfully");

                // Trigger auto-analysis in background
                setTimeout(() => {
                    this.addChatMessage("System", `I've analyzed <b>${data.length} rows</b>. Ask me to "Summarize" or "Find outliers".`);
                }, 1000);
            },

            renderTable() {
                const { data, headers, currentPage, rowsPerPage } = this.state;
                const start = (currentPage - 1) * rowsPerPage;
                const end = start + rowsPerPage;
                const pageData = data.slice(start, end);

                const thead = document.getElementById('table-header');
                thead.innerHTML = headers.map(h => `<th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50 dark:bg-dark-surface dark:text-gray-400 border-b border-gray-200 dark:border-dark-border whitespace-nowrap">${h}</th>`).join('');

                const tbody = document.getElementById('table-body');
                tbody.innerHTML = pageData.map(row => {
                    return `<tr class="hover:bg-gray-50 dark:hover:bg-white/5 transition-colors">
                        ${headers.map(h => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300 border-b border-gray-200 dark:border-dark-border">${row[h] !== undefined ? row[h] : '-'}</td>`).join('')}
                    </tr>`;
                }).join('');

                // Update Info
                document.getElementById('page-info').textContent = `Showing ${start + 1} to ${Math.min(end, data.length)} of ${data.length}`;
                document.getElementById('row-count-display').textContent = `${data.length} rows`;
            },

            setupNavigation() {
                document.getElementById('prev-page').addEventListener('click', () => {
                    if (this.state.currentPage > 1) {
                        this.state.currentPage--;
                        this.renderTable();
                    }
                });
                document.getElementById('next-page').addEventListener('click', () => {
                    if (this.state.currentPage * this.state.rowsPerPage < this.state.data.length) {
                        this.state.currentPage++;
                        this.renderTable();
                    }
                });
                
                // Search
                document.getElementById('table-search').addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    const filtered = this.state.data.filter(row => 
                        Object.values(row).some(val => String(val).toLowerCase().includes(term))
                    );
                    // For demo simplicity, re-render logic is simplified:
                    // In a real app, we'd update a 'displayData' state separate from 'rawData'
                    if(term === '') {
                         this.renderTable(); 
                    } else {
                        // Quick filter render hack
                        const tbody = document.getElementById('table-body');
                        tbody.innerHTML = filtered.slice(0, 50).map(row => {
                            return `<tr class="hover:bg-gray-50 dark:hover:bg-white/5">
                                ${this.state.headers.map(h => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300 border-b border-gray-200 dark:border-dark-border">${row[h]}</td>`).join('')}
                            </tr>`;
                        }).join('');
                    }
                });
            },

            // --- Visualization ---

            populateDropdowns(headers) {
                const xSelect = document.getElementById('axis-x');
                const ySelect = document.getElementById('axis-y');
                
                const options = headers.map(h => `<option value="${h}">${h}</option>`).join('');
                
                xSelect.innerHTML = options;
                ySelect.innerHTML = options;
                
                // Smart select defaults
                // Try to find a string for X and number for Y
                const stringCol = headers.find(h => typeof this.state.data[0][h] === 'string');
                const numCol = headers.find(h => typeof this.state.data[0][h] === 'number');
                
                if(stringCol) xSelect.value = stringCol;
                if(numCol) ySelect.value = numCol;
            },

        renderChart() {
            const ctx = document.getElementById('mainChart');
            const type = document.getElementById('chart-type').value;
            const xKey = document.getElementById('axis-x').value; // e.g., 'Sex'
            const yKey = document.getElementById('axis-y').value; // e.g., 'Age'

            if (!this.state.data.length) return alert("Please upload data first.");

            // Show canvas, hide placeholder
            document.getElementById('chart-placeholder').classList.add('hidden');
            ctx.classList.remove('hidden');

            // ==========================================================
            // ðŸš€ NEW AGGREGATION LOGIC STARTS HERE ðŸš€
            // ==========================================================
            const aggregationMap = {};
            
            // Step 1: Group the data and calculate the totals
            this.state.data.forEach(row => {
                const category = row[xKey];
                // Convert value to a number, ensuring robustness
                const value = parseFloat(row[yKey]); 
                
                if (!aggregationMap[category]) {
                    aggregationMap[category] = { totalValue: 0, count: 0 };
                }
                
                if (!isNaN(value)) {
                    aggregationMap[category].totalValue += value;
                    aggregationMap[category].count += 1;
                }
            });

            // Step 2: Extract the final labels and calculate the average (the fix!)
            const labels = Object.keys(aggregationMap); // e.g., ['Male', 'Female']
            const values = labels.map(label => {
                const agg = aggregationMap[label];
                // Calculate the average (Total Value / Count)
                return agg.count > 0 ? agg.totalValue / agg.count : 0; 
            });
            // ==========================================================
            // ðŸš€ NEW AGGREGATION LOGIC ENDS HERE ðŸš€
            // ==========================================================


            if (this.state.chartInstance) {
                this.state.chartInstance.destroy();
            }

            // Theme colors (unchanged)
            const isDark = document.documentElement.classList.contains('dark');
            const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
            const textColor = isDark ? '#9ca3af' : '#4b5563';

            this.state.chartInstance = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels, // Uses the new aggregated labels
                    datasets: [{
                        label: yKey + ' (Average)',
                        data: values, // Uses the new aggregated values (averages)
                        // ... (rest of dataset styling)
                    }]
                },
                options: {
                    // ... (rest of options)
                }
            });
        },
            downloadChart() {
                const link = document.createElement('a');
                link.download = 'insightflow-chart.png';
                link.href = document.getElementById('mainChart').toDataURL();
                link.click();
            },

            // --- AI Copilot (Mock) ---

            handleChat() {
                const input = document.getElementById('chat-input');
                const query = input.value.trim();
                if (!query) return;

                // User Message
                this.addChatMessage('User', query);
                input.value = '';

                // Simulate AI Thinking
                const loader = document.getElementById('ai-loading');
                loader.classList.remove('hidden');
                loader.scrollIntoView();

                setTimeout(() => {
                    loader.classList.add('hidden');
                    this.generateAIResponse(query);
                }, 1500);
            },

            addChatMessage(sender, htmlContent) {
                const container = document.getElementById('chat-history');
                const isUser = sender === 'User';
                
                const div = document.createElement('div');
                div.className = `flex gap-4 ${isUser ? 'flex-row-reverse' : ''} animate-fade-in`;
                
                const avatar = isUser 
                    ? `<div class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-xs font-bold">You</div>`
                    : `<div class="w-8 h-8 rounded-lg bg-gradient-to-br from-brand-500 to-indigo-600 flex items-center justify-center"><i data-lucide="sparkles" class="text-white w-4 h-4"></i></div>`;
                
                const bubbleClass = isUser
                    ? 'bg-brand-600 text-white rounded-2xl rounded-tr-none'
                    : 'glass-panel text-gray-200 rounded-2xl rounded-tl-none';

                div.innerHTML = `
                    ${avatar}
                    <div class="${bubbleClass} p-4 max-w-[80%] text-sm leading-relaxed shadow-lg">
                        ${htmlContent}
                    </div>
                `;
                
                container.appendChild(div);
                lucide.createIcons();
                div.scrollIntoView({ behavior: 'smooth' });
            },

            generateAIResponse(query) {
                const q = query.toLowerCase();
                let response = "";

                if (this.state.data.length === 0) {
                    response = "I don't see any data uploaded yet. Please upload a CSV or Excel file so I can analyze it.";
                } else if (q.includes("summary") || q.includes("summarize") || q.includes("overview")) {
                    // Calc stats
                    const numCols = this.state.headers.filter(h => typeof this.state.data[0][h] === 'number');
                    response = `
                        <b>Dataset Summary:</b><br>
                        This dataset contains <b>${this.state.data.length} rows</b> and <b>${this.state.headers.length} columns</b>.<br><br>
                        <b>Numeric Columns detected:</b> ${numCols.join(', ')}.<br>
                        I recommend visualizing the distribution of <i>${numCols[0] || 'the first column'}</i>.
                    `;
                } else if (q.includes("clean") || q.includes("fix")) {
                    response = "I've scanned the dataset for missing values. <br> Found <b>0 null values</b> (Mock check). <br> The data appears clean and ready for visualization.";
                } else if (q.includes("report") || q.includes("pdf")) {
                    response = `I'm generating a comprehensive PDF report of your current view... <br> <button onclick="app.exportPDF()" class="mt-2 px-3 py-1 bg-white text-black rounded text-xs font-bold">Download PDF</button>`;
                } else if (q.includes("chart") || q.includes("plot") || q.includes("graph")) {
                    response = "I've updated the settings to suggest a chart. Go to the <b>Visualization</b> tab to see it.";
                    // Logic to auto-switch tab could go here
                } else {
                    response = `That's an interesting question about your data. Based on the <b>${this.state.headers[0]}</b> column, I can see a trend forming. Would you like me to calculate the correlation matrix?`;
                }

                this.typewriterEffect(response);
            },

            typewriterEffect(html) {
                // Simplified typewriter for HTML content involves just appending the block
                // but adding a 'cursor' class to the container briefly
                this.addChatMessage('AI', `<span class="cursor-typing">${html}</span>`);
            },

            exportPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(20);
                doc.text("InsightFlow AI Analysis Report", 20, 20);
                
                doc.setFontSize(12);
                doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 20, 30);
                doc.text(`Dataset Rows: ${this.state.data.length}`, 20, 40);
                doc.text(`Columns: ${this.state.headers.join(', ')}`, 20, 50);

                doc.text("AI Summary:", 20, 70);
                doc.setFontSize(10);
                const splitText = doc.splitTextToSize("The dataset was processed successfully. No critical errors found. Distribution analysis suggests normal variance in numeric fields.", 170);
                doc.text(splitText, 20, 80);

                doc.save("InsightFlow-Report.pdf");
                this.showToast("PDF Report Downloaded");
            }
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });

    </script>
</body>
</html>